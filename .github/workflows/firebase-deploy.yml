name: Firebase Deployment

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

jobs:
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.FIREBASE_PROJECT_ID }}

      - name: Verify Firebase project
        run: |
          firebase projects:list
          firebase use ${{ env.FIREBASE_PROJECT_ID }}

      - name: Deploy Firestore rules and indexes
        run: |
          echo "Deploying Firestore rules and indexes..."
          firebase deploy --only firestore --project ${{ env.FIREBASE_PROJECT_ID }}

      - name: Build static files for hosting
        run: |
          echo "Preparing static files for Firebase Hosting..."
          # í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì— ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
          # ì˜ˆ: npm run build

      - name: Deploy to Firebase Hosting
        run: |
          echo "Deploying to Firebase Hosting..."
          firebase deploy --only hosting --project ${{ env.FIREBASE_PROJECT_ID }}

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: public
          branch: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and deploy to Cloud Run (Dashboard)
        if: success()
        run: |
          echo "Building and deploying Streamlit dashboard to Cloud Run..."
          gcloud run deploy money-flow-dashboard \
            --source . \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 1 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --set-env-vars ENVIRONMENT=production,FIREBASE_PROJECT_ID=${{ env.FIREBASE_PROJECT_ID }} \
            --project ${{ env.FIREBASE_PROJECT_ID }}

      - name: Get deployment URLs
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo ""
          echo "ðŸ“ Firebase Hosting URL:"
          echo "   https://${{ env.FIREBASE_PROJECT_ID }}.web.app"
          echo "   https://${{ env.FIREBASE_PROJECT_ID }}.firebaseapp.com"
          echo ""
          echo "ðŸ“ Cloud Run Dashboard URL:"
          gcloud run services describe money-flow-dashboard \
            --platform managed \
            --region us-central1 \
            --format 'value(status.url)' \
            --project ${{ env.FIREBASE_PROJECT_ID }}

      - name: Deploy summary
        if: success()
        run: |
          echo "# ðŸ’° Money Flow Prediction System" >> $GITHUB_STEP_SUMMARY
          echo "> **\"ë¬¼ì˜ íë¦„ì„ ì½ëŠ” ìžê°€ ì‹œìž¥ì„ ì§€ë°°í•œë‹¤\"**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ì‹¤ì‹œê°„ ê¸€ë¡œë²Œ ìžê¸ˆ íë¦„ì„ ì¶”ì í•˜ê³  AI ê¸°ë°˜ ì˜ˆì¸¡ìœ¼ë¡œ ì‹œìž¥ì˜ ë‹¤ìŒ ì›€ì§ìž„ì„ í¬ì°©í•˜ëŠ” í†µí•© ê¸ˆìœµ ë¶„ì„ í”Œëž«í¼ìž…ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ ë°°í¬ ì„±ê³µ (Deployment Successful!)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ë°”ë¡œê°€ê¸° (Direct Links)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“Š **ëŒ€ì‹œë³´ë“œ ì—´ê¸° (Open Dashboard)**](https://${{ env.FIREBASE_PROJECT_ID }}.web.app/dashboard)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸŒ **ëžœë”© íŽ˜ì´ì§€ (Landing Page)**](https://${{ env.FIREBASE_PROJECT_ID }}.web.app)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ ì£¼ìš” ê¸°ëŠ¥ (Key Features)" >> $GITHUB_STEP_SUMMARY
          echo "| ê¸°ëŠ¥ | ìƒì„¸ ì„¤ëª… |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ **ì‹¤ì‹œê°„ ë°ì´í„°** | ì±„ê¶Œ, í†µí™”, ETF ìžê¸ˆ íë¦„ ì¶”ì  |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– **AI ì˜ˆì¸¡** | LSTM/Transformer ê¸°ë°˜ ì˜ˆì¸¡ |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”” **ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼** | ì´ìƒ ì§•í›„ ì‹¤ì‹œê°„ ê°ì§€ ë° ì „ì†¡ |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š **ëŒ€ì‹œë³´ë“œ** | Plotly ê¸°ë°˜ ì¸í„°ëž™í‹°ë¸Œ ì‹œê°í™” |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ ë°°í¬ ì •ë³´ (Deployment Info)" >> $GITHUB_STEP_SUMMARY
          echo "- **ìƒíƒœ**: âœ… ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          echo "- **ì¼ì‹œ**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **í™˜ê²½**: \`${{ github.event.inputs.environment || 'production' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ë°°í¬ëœ ì„œë¹„ìŠ¤" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Pages**: í”„ë¡œì íŠ¸ ëžœë”© íŽ˜ì´ì§€ (GitHub í˜¸ìŠ¤íŒ…)" >> $GITHUB_STEP_SUMMARY
          echo "- **Firebase Hosting**: ì •ì  íŒŒì¼ ë° ëžœë”© íŽ˜ì´ì§€" >> $GITHUB_STEP_SUMMARY
          echo "- **Cloud Run**: Streamlit ë¶„ì„ ëŒ€ì‹œë³´ë“œ" >> $GITHUB_STEP_SUMMARY
          echo "- **Firestore**: ë°ì´í„°ë² ì´ìŠ¤ ê·œì¹™ ë° ì¸ë±ìŠ¤" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
